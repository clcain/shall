#!/bin/bash

shall_dir=$(dirname $(dirname $(readlink $(which shall))))
shall_groups_dir="$shall_dir/groups/"
shall_logs_dir="$shall_dir/logs/"

if [ -z "$2" ]
then
    echo "No command provided."
    echo "Usage: shalld <GROUP> <COMMAND> [ARGS]"
    exit 1
fi

group=$1

if [ ! -e $shall_groups_dir/$group ]
then
    echo "Unable to find group $group."
    exit 1
fi

hosts=$(grep "^Host " $shall_groups_dir/$group | sed "s/Host //g")

mkdir -p $shall_logs_dir/$group
cd $shall_logs_dir/$group

for host in $hosts; do
    echo >> $host
    date >> $host
    echo $host >> $host
    ssh -o StrictHostKeyChecking=accept-new $host "${@:2}" >> $host 2>&1 &
done
